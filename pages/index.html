<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Journal Tracker</title>
    <style>
      :root {
        --nyu-purple: #57068c;
        --nyu-purple-dark: #3f0466;
        --bg-light: #f7f7f9;
        --border-light: #e5e7eb;
        --text-dark: #2a2a2a;
        --highlight: #fff3bf;
      }
      body {
        font-family: "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont,
          sans-serif;
        margin: 0;
        padding: 24px;
        background-color: var(--bg-light);
        color: var(--text-dark);
      }
      h1 {
        color: var(--nyu-purple);
        margin-bottom: 4px;
      }
      p {
        margin-top: 0;
        color: #555;
      }
      .card {
        background: #fff;
        border-radius: 10px;
        padding: 16px 20px;
        margin-bottom: 16px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
      }
      #updateControls,
      #filters,
      #tableControls {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
        margin-bottom: 10px;
      }
      label {
        font-size: 0.9rem;
        color: #444;
      }
      input[type="text"],
      input[type="date"],
      select {
        padding: 6px 10px;
        border-radius: 6px;
        border: 1px solid var(--border-light);
        font-size: 0.9rem;
      }
      button {
        padding: 7px 14px;
        border-radius: 6px;
        border: none;
        background-color: var(--nyu-purple);
        color: #fff;
        font-size: 0.9rem;
        cursor: pointer;
        transition: background-color 0.15s ease;
      }
      button:hover {
        background-color: var(--nyu-purple-dark);
      }
      button.secondary {
        background-color: #e5e7eb;
        color: #333;
      }
      button.secondary:hover {
        background-color: #d1d5db;
      }
      #updateMessage {
        font-size: 0.85rem;
        color: #555;
        margin-left: auto;
      }
      table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        background: #fff;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
      }
      thead th {
        position: sticky;
        top: 0;
        background-color: var(--nyu-purple);
        color: #fff;
        text-align: left;
        padding: 10px;
        font-weight: 500;
        cursor: pointer;
      }
      tbody td {
        padding: 10px;
        border-bottom: 1px solid var(--border-light);
        font-size: 0.9rem;
      }
      tbody tr:hover {
        background-color: #fafafa;
      }
      tr.unchanged {
        opacity: 0.65;
      }
      tr.unchanged:hover {
        opacity: 1;
      }
      .Changed {
        background-color: var(--highlight);
      }
      #loading {
        font-style: italic;
        color: #666;
        margin: 10px 0;
      }
      #stats {
        margin-top: 10px;
        font-size: 0.85rem;
        color: #444;
      }
      footer {
        margin-top: 24px;
        font-size: 0.8rem;
        color: #666;
        text-align: center;
      }
      .dashboard {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 16px;
        text-align: center;
      }
      .metric {
        background: #fafafa;
        border-radius: 8px;
        padding: 14px;
      }
      .metric-value {
        display: block;
        font-size: 1.6rem;
        font-weight: 600;
        color: var(--nyu-purple);
      }
      .metric-label {
        font-size: 0.85rem;
        color: #555;
      }
      .status {
        padding: 3px 8px;
        border-radius: 999px;
        font-size: 0.75rem;
        font-weight: 500;
      }
      .status.updated {
        background: #fde68a;
        color: #92400e;
      }
      .status.unchanged {
        background: #e5e7eb;
        color: #374151;
      }
      .truncate {
        display: inline-block;
        max-width: 420px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        vertical-align: bottom;
      }
      .row-toggle,
      .index-btn {
        all: unset;
        cursor: pointer;
        font-size: 1.2rem;
        line-height: 1;
        margin-left: 6px;
        vertical-align: middle;
        color: var(--nyu-purple) !important;
        transition: transform 0.15s ease;
      }
      .row-toggle:hover,
      .index-btn:hover {
        transform: scale(1.2);
        color: var(--nyu-purple) !important;
        background: transparent !important;
      }
      .index-btn {
        transition: transform 0.15s ease, font-weight 0.15s ease;
      }
      .index-btn.active {
        font-weight: 700;
        transform: scale(1.15);
      }
      .details-row td {
        background: #f9f9fb;
        border-bottom: 1px solid var(--border-light);
      }
      .details {
        padding: 10px 14px;
        font-size: 0.85rem;
        color: #444;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 10px;
      }
      @media (max-width: 600px) {
        .details {
          grid-template-columns: 1fr;
          display: block;
        }
      }
      .sort-arrows span {
        font-size: 0.7em;
        color: white;
        margin-left: 2px;
      }
      th.sorted-asc .sort-arrows .asc,
      th.sorted-desc .sort-arrows .desc {
        color: green;
      }
      #indexBar .index-btn {
        padding: 6px 10px;
        border-radius: 6px;
        border: 1px solid var(--border-light);
        font-size: 0.9rem;
        background: #fff;
      }
      #indexBar .index-btn:hover {
        background: var(--nyu-purple);
        transform: scale(1.1);
      }
    </style>
  </head>
  <body>
    <div
      style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px"
    >
      <img
        src="https://d2jv02qf7xgjwx.cloudfront.net/accounts/129950/images/NYUL-Health_logo_Purple_RGB_300ppi.png"
        alt="NYU Langone Health"
        style="height: auto; width: 200px"
      />
      <span style="font-size: 1rem; color: #555"
        ><strong>Health Sciences Library</strong></span
      >
    </div>

    <h1>Journal Title Tracker</h1>
    <p>Track changes in the journal titles over time.</p>

    <div class="card">
      <div id="updateControls">
        <button id="updateBtn">Update</button>
        <label for="autoUpdateSelect">Auto-update every:</label>
        <select id="autoUpdateSelect">
          <option value="0">Off</option>
          <option value="30000">30 seconds</option>
          <option value="60000">1 minute</option>
          <option value="3600000">1 hour</option>
          <option value="86400000">1 day</option>
        </select>
        <span id="updateMessage">No updates yet.</span>
        <button id="resetBtn">Reset Update Notification</button>
      </div>
    </div>

    <div class="card" id="filters">
      <input type="text" id="searchBox" placeholder="Search ISSN or Title" />
      <label>From: <input type="date" id="fromDate" /></label>
      <label>To: <input type="date" id="toDate" /></label>
      <label style="display: flex; align-items: center; gap: 6px">
        <input type="checkbox" id="showChangesOnly" /> Show changes only
      </label>
      <button id="filterBtn">Apply Filters</button>
      <button id="exportBtn">Export CSV</button>
      <button id="exportChangesBtn">Export Changes Only</button>
    </div>

    <div class="card dashboard">
      <div class="metric">
        <span class="metric-value" id="metricTotal">0</span>
        <span class="metric-label">Total Journals</span>
      </div>
      <div class="metric">
        <span class="metric-value" id="metricUpdated">0</span>
        <span class="metric-label">Updated</span>
      </div>
      <div class="metric">
        <span class="metric-value" id="metricUnchanged">0</span>
        <span class="metric-label">Unchanged</span>
      </div>
    </div>

    <div class="card" id="indexBar">
  <button class="index-btn" data-letter="All">All</button>
  <button class="index-btn" data-letter="A">A</button>
  <button class="index-btn" data-letter="B">B</button>
  <button class="index-btn" data-letter="C">C</button>
  <button class="index-btn" data-letter="D">D</button>
  <button class="index-btn" data-letter="E">E</button>
  <button class="index-btn" data-letter="F">F</button>
  <button class="index-btn" data-letter="G">G</button>
  <button class="index-btn" data-letter="H">H</button>
  <button class="index-btn" data-letter="I">I</button>
  <button class="index-btn" data-letter="J">J</button>
  <button class="index-btn" data-letter="K">K</button>
  <button class="index-btn" data-letter="L">L</button>
  <button class="index-btn" data-letter="M">M</button>
  <button class="index-btn" data-letter="N">N</button>
  <button class="index-btn" data-letter="O">O</button>
  <button class="index-btn" data-letter="P">P</button>
  <button class="index-btn" data-letter="Q">Q</button>
  <button class="index-btn" data-letter="R">R</button>
  <button class="index-btn" data-letter="S">S</button>
  <button class="index-btn" data-letter="T">T</button>
  <button class="index-btn" data-letter="U">U</button>
  <button class="index-btn" data-letter="V">V</button>
  <button class="index-btn" data-letter="W">W</button>
  <button class="index-btn" data-letter="X">X</button>
  <button class="index-btn" data-letter="Y">Y</button>
  <button class="index-btn" data-letter="Z">Z</button>
</div>

    <div class="card" id="tableControls">
      <button id="toggleExpandBtn" title="Show/Hide Status Details">
        Expand All
      </button>
    </div>

    <table id="journalTable">
      <thead>
        <tr>
          <th data-key="issn">
            ISSN
            <span class="sort-arrows"
              ><span class="asc">▲</span><span class="desc">▼</span></span
            >
          </th>
          <th data-key="title">
            Title
            <span class="sort-arrows"
              ><span class="asc">▲</span><span class="desc">▼</span></span
            >
          </th>
          <th data-key="previousTitle">
            Previous Title
            <span class="sort-arrows"
              ><span class="asc">▲</span><span class="desc">▼</span></span
            >
          </th>
          <th data-key="changed">
            Status
            <span class="sort-arrows"
              ><span class="asc">▲</span><span class="desc">▼</span></span
            >
          </th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div id="stats"></div>

    <script>
      // --- State ---
      let allJournals = [],
        filteredJournals = [],
        renderOffset = 0,
        renderChunkSize = 50;
      let autoUpdateInterval = null,
        updateCount = 0;

      const tbody = document.querySelector("#journalTable tbody");
      const searchBox = document.getElementById("searchBox");
      const fromDate = document.getElementById("fromDate");
      const toDate = document.getElementById("toDate");
      const showChangesOnlyCheckbox =
        document.getElementById("showChangesOnly");
      const loading = document.getElementById("loading");
      const statsDiv = document.getElementById("stats");
      const updateMessage = document.getElementById("updateMessage");
      const updateBtn = document.getElementById("updateBtn");
      const autoUpdateSelect = document.getElementById("autoUpdateSelect");
      const resetBtn = document.getElementById("resetBtn");

      // --- Fetch journals ---
      async function fetchJournals() {
        try {
          const res = await fetch("/alljournals");
          const data = await res.json();
          allJournals = data.map((j) => ({
            issn: j.issn,
            title: j.title,
            previousTitle: j.oldTitle || null,
            changed: j.oldTitle && j.oldTitle !== j.title,
            dateChecked: new Date().toISOString().split("T")[0],
          }));
          filteredJournals = allJournals.slice();
          renderOffset = 0;
          renderTable(filteredJournals);
        } catch (err) {
          console.error("Error fetching journals:", err);
          allJournals = [];
        }
      }

      // --- Sorting ---
      let sortDirection = {};
      function sortJournals(journals, key = "changed") {
        return journals.slice().sort((a, b) => {
          if (key === "changed")
            return (b.changed === true) - (a.changed === true);
          let valA = (a[key] ?? "").toString().toLowerCase();
          let valB = (b[key] ?? "").toString().toLowerCase();
          return (
            (valA < valB ? -1 : valA > valB ? 1 : 0) *
            (sortDirection[key] ? 1 : -1)
          );
        });
      }

      // --- Render table ---
      function renderTable(journals) {
        tbody.innerHTML = "";
        journals.forEach((j) => renderRow(j));
        updateStats(journals);
      }

      function renderRow(j) {
        const tr = document.createElement("tr");
        tr.classList.add(j.changed ? "Changed" : "unchanged");
        tr.innerHTML = `
        <td>${j.issn}</td>
        <td title="${j.title}"><span class="truncate">${j.title}</span></td>
        <td>${j.previousTitle || "-"}</td>
        <td>
          <span class="status-${j.changed ? "updated" : "unchanged"}">${
          j.changed ? "Updated" : "Unchanged"
        }</span>
          <button class="row-toggle" aria-label="Toggle Details">▸</button>
        </td>
      `;
        const detailsRow = document.createElement("tr");
        detailsRow.classList.add("details-row");
        detailsRow.style.display = "none";
        detailsRow.innerHTML = `
        <td colspan="4">
          <div class="details">
            <div><strong>ISSN:</strong> ${j.issn}</div>
            <div><strong>Previous Title:</strong> ${
              j.previousTitle || "-"
            }</div>
            <div><strong>Last Checked:</strong> ${j.dateChecked || "-"}</div>
          </div>
        </td>
      `;
        const toggleBtn = tr.querySelector(".row-toggle");
        toggleBtn.dataset.open = "false";
        toggleBtn.addEventListener("click", () => {
          const isOpen = toggleBtn.dataset.open === "true";
          detailsRow.style.display = isOpen ? "none" : "table-row";
          toggleBtn.textContent = isOpen ? "▸" : "▾";
          toggleBtn.dataset.open = !isOpen;
        });
        tbody.appendChild(tr);
        tbody.appendChild(detailsRow);
      }

      // --- Filters ---
      function applyFilters() {
        let filtered = allJournals.slice();
        const term = searchBox.value.toLowerCase().trim();
        const from = fromDate.value ? new Date(fromDate.value) : null;
        const to = toDate.value ? new Date(toDate.value) : null;
        const changesOnly = showChangesOnlyCheckbox.checked;

        if (term)
          filtered = filtered.filter(
            (j) => j.issn.includes(term) || j.title.toLowerCase().includes(term)
          );
        if (from)
          filtered = filtered.filter(
            (j) => j.dateChecked && new Date(j.dateChecked) >= from
          );
        if (to)
          filtered = filtered.filter(
            (j) => j.dateChecked && new Date(j.dateChecked) <= to
          );
        if (changesOnly) filtered = filtered.filter((j) => j.changed);
        filteredJournals = filtered;
        renderTable(filtered);
      }

      searchBox.addEventListener("input", applyFilters);
      fromDate.addEventListener("change", applyFilters);
      toDate.addEventListener("change", applyFilters);
      showChangesOnlyCheckbox.addEventListener("change", applyFilters);
      document
        .getElementById("filterBtn")
        .addEventListener("click", applyFilters);

      // --- CSV export ---
      function downloadCSV(filename, journals) {
        const header = ["ISSN", "Title", "Previous Title", "Status"];
        const rows = journals.map((j) => [
          j.issn,
          j.title,
          j.previousTitle || "",
          j.changed ? "Updated" : "Unchanged",
        ]);
        const csv = [header, ...rows]
          .map((r) => r.map((c) => `"${c}"`).join(","))
          .join("\n");
        const blob = new Blob([csv], { type: "text/csv" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
      }
      document
        .getElementById("exportBtn")
        .addEventListener("click", () =>
          downloadCSV("all_journals.csv", filteredJournals)
        );
      document
        .getElementById("exportChangesBtn")
        .addEventListener("click", () =>
          downloadCSV(
            "changes_only.csv",
            filteredJournals.filter((j) => j.changed)
          )
        );

      // --- Metrics ---
      function updateStats(journals) {
        const total = journals.length,
          updated = journals.filter((j) => j.changed).length,
          unchanged = total - updated;
        document.getElementById("metricTotal").textContent = total;
        document.getElementById("metricUpdated").textContent = updated;
        document.getElementById("metricUnchanged").textContent = unchanged;
        statsDiv.innerHTML = `<strong>Total:</strong> ${total} | <strong>Updated:</strong> ${updated} | <strong>Unchanged:</strong> ${unchanged}`;
      }

      // --- Expand/Collapse ---
      document
        .getElementById("toggleExpandBtn")
        .addEventListener("click", () => {
          const btn = document.getElementById("toggleExpandBtn");
          const expand = btn.textContent === "Expand All";
          document.querySelectorAll(".row-toggle").forEach((t) => {
            if (expand && t.dataset.open === "false") t.click();
            else if (!expand && t.dataset.open === "true") t.click();
          });
          btn.textContent = expand ? "Collapse All" : "Expand All";
        });

      // --- A-Z Index ---
      document.querySelectorAll(".index-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          document
            .querySelectorAll(".index-btn")
            .forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          const letter = btn.dataset.letter;
          filteredJournals =
            letter === "All"
              ? allJournals.slice()
              : allJournals.filter(
                  (j) => j.title && j.title[0].toUpperCase() === letter
                );
          renderTable(filteredJournals);
        });
      });

      // --- Auto-update ---
      async function autoUpdate() {
        const oldTitles = allJournals.map((j) => ({
          issn: j.issn,
          title: j.title,
        }));
        await fetchJournals();
        const changes = allJournals.some((j) => {
          const o = oldTitles.find((ot) => ot.issn === j.issn);
          return o && o.title !== j.title;
        });
        const now = new Date().toLocaleString();
        updateMessage.textContent = changes
          ? `New Update since ${now}`
          : `No changes at ${now}`;
      }
      updateBtn.addEventListener("click", autoUpdate);
      autoUpdateSelect.addEventListener("change", () => {
        const interval = parseInt(autoUpdateSelect.value, 10);
        if (autoUpdateInterval) {
          clearInterval(autoUpdateInterval);
          autoUpdateInterval = null;
        }
        if (interval > 0)
          autoUpdateInterval = setInterval(autoUpdate, interval);
      });
      resetBtn.addEventListener(
        "click",
        () => (updateMessage.textContent = "No updates yet.")
      );

      // --- Initial load ---
      window.addEventListener("load", fetchJournals);
    </script>
  </body>
</html>
